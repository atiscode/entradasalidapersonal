@model CodificacionEquipoCompleta

@{
    ViewBag.Title = "Formulario";
    Layout = "~/Views/Shared/_Layout.cshtml";

    CodificacionEquipoInfo cabecera = Model.Codificacion;

    List<string> listadoEquipos = ViewBag.EquiposRequeridos;

    int requerimientoEquipoID = (int)ViewBag.requerimientoID;

    var usuario = UsuarioDAL.ConsultarUsuario((int)ViewBag.UsuarioID);
    var informacionIngreso = IngresoDAL.ConsultarIngresoByUsuarioID((int)ViewBag.UsuarioID);
}

<link href="~/Content/css/Formulario.css" rel="stylesheet" />
<style>
    /* OCULTAR COLUMNAS ID DE LAS TABLAS DINAMICAS */
    #tbl-Detalles tr > *:nth-child(1) {
        display: none;
    }
    .upload-btn-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }

    .btn-adjuntos {
        border: 2px solid gray;
        color: #f4901f;
        background-color: white;
        /*padding: 8px 20px;*/
        border-radius: 8px;
        /*font-size: 20px;*/
        font-weight: bold;
    }

    .upload-btn-wrapper input[type=file] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
    }
</style>

<div class="panel">

    <div class="panel-heading-create custom-header-panel">
        <h4>@ViewBag.TituloPanel <div class="pull-right"> @System.DateTime.Now.ToString("yyyy/MM/dd")</div></h4>
    </div>

    <div class="panel-body">

        <form action="#" id="form-CodificacionEquipo" role="form" data-toggle="validator" method="post" accept-charset="utf-8">

            @Html.Hidden("IDCodificacionEquipo", cabecera.IDCodificacionEquipo)
            @Html.Hidden("RequerimientoEquipoID", requerimientoEquipoID)
            @Html.Hidden("UsuarioCodificadorID", cabecera.UsuarioCodificadorID)
            @Html.Hidden("FechaCodificacionEquipo", DateTime.Now)
            @Html.Hidden("Estado", true)

        </form>

        <form action="#" id="form-Cabecera" role="form" data-toggle="validator" method="post" accept-charset="utf-8">
            @Html.Partial("_Cabecera", new ViewDataDictionary { { "DatosUsuario", usuario }, { "InformacionIngreso", informacionIngreso } })
        </form>

        @Html.Partial("_Detalles", new ViewDataDictionary { { "TituloPanelDetalle", "Detalles" }, { "ListadoDetalles", Model.Detalles }, { "EquiposRequeridos", listadoEquipos } })

        <div class="row fila-seccion">
            <div class="col-xs-6" style="text-align: right;">
                <input id="guardar" type="button" value="Guardar" class="btn btn-default" />
            </div>
            <div class="col-xs-6" style="text-align: left;">
                @Html.ActionLink("Regresar", "Index", null, new { @class = "btn btn-default" })
            </div>
        </div>
    </div>
</div>


@section ViewSpecificJavascript {
    <script>
        var urlAccionGuardar = '@Url.Action("CreateCodificacion")';
        var urlAccionEditar = '@Url.Action("Edit")';
        var urlAccionListado = '@Url.Action("Index")';
        var urlAccionInformacionEquipo = '@Url.Action("_InformacionEquipo")';

        var archivosAdjuntos = [];

        var contador = 0;

        $(window).on('load', function () {
            let inputsFile = $("#tbl-Detalles").find('input[type="file"]');
            inputsFile.each(function (index, value) {
                if (value.length > 0) {
                    archivosAdjuntos.push('')
                }
            })
        })

        $(document).ready(function () {
            $('.agregarFila').click(function (e) {

                var template = $(this).closest("tr");
                var idTemplate = $(template).attr('id')

                var  tabla = template.closest("table")
                var idTabla = $(tabla).attr('id')

                e.preventDefault();
                var esFilaVacia = filaVacia(idTemplate);
                if (!esFilaVacia) {
                    agregarFila(idTemplate, idTabla, contador)
                    contador++;

                } else {
                    toastr.error('@Mensajes.MensajeDatosObligatorios');
                }
            });
        })

        function guardar() {

            var cabecera = $('#form-CodificacionEquipo').serializeObject()

            var detalles = GetListadoTablaDinamica("tbl-Detalles", false)

            let accion = $("#IDCodificacionEquipo").val() == 0 ? urlAccionGuardar : urlAccionEditar;

            var data_form = JSON.stringify({ "formulario": cabecera, "detalles": detalles, "archivos": archivosAdjuntos })
            _Guardar(data_form, accion, urlAccionListado)
        }

        function convertToBase64CodificacionCompleta(element) {
            //Read File

            var id = parseInt($(element).attr('id'));

            var selectedFile = document.getElementById(id).files;
            //Check File is not Empty
            if (selectedFile.length > 0) {
                // Select the very first file from list
                var fileToLoad = selectedFile[0];
                // FileReader function for read the file.
                var fileReader = new FileReader();
                var base64;
                // Onload of file read the file content
                fileReader.onload = function (fileLoadedEvent) {
                    base64 = fileLoadedEvent.target.result;
                    // Print data in console
                    //console.log(base64);
                    archivosAdjuntos[id] = "abc";
                };
                // Convert data to base64
                fileReader.readAsDataURL(fileToLoad);
            }
        }

        function convertToBase64(element) {
            var idCodificacionEquipo = element.id.replace('Adjunto_', '');

            var formdata = new FormData(); //FormData object
            var fileInput = document.getElementById('Adjunto_' + idCodificacionEquipo);

            for (i = 0; i < fileInput.files.length; i++) {
                //Appending each file to FormData object
                formdata.append(fileInput.files[i].name, fileInput.files[i]);
            }
            //Creating an XMLHttpRequest and sending
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/CodificacionEquipo/_Cargar');
            xhr.send(formdata);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var respuesta = JSON.parse(xhr.responseText);
                    if (respuesta.resultado.Estado === true) {
                        archivosAdjuntos[idCodificacionEquipo] =respuesta.resultado.Respuesta;
                    } else {
                        toastr.error('Error al guardar el archivo. Contacte al adminstrador.');
                    }

                }
            }
            return false;
        }

        $("#guardar").click(function () {            

            var flag = validarCamposRequeridosFormularioCompleto("form-CodificacionEquipo");
            let validacion = TablaDinamicaVacia("tbl-Detalles");

            if (flag && !validacion)
                guardar();
            else
                toastr.error('@Mensajes.MensajeDatosObligatorios')
        })

        $(".informacion-equipo").click(function (e) {

            let elemento = $(e.currentTarget);

            var fila = elemento.closest("tr"); // fila
            var ddlPrefactura = fila.find("select"); // dropdownlist
            var valor = parseInt($(ddlPrefactura).val()); // valor seleccionado

            if (!valor) {
                toastr.error('@Mensajes.MensajeErrorSeleccionVacia')
                return;
            }

            _GetCreate({ id: valor }, urlAccionInformacionEquipo);
            $('#contenido-modal').modal({
                'show': 'true',
                'backdrop': 'static',
                'keyboard': false
            });
            return;
        })

    </script>
    <script src="~/Content/js/TablaDinamica.js"></script>
}
